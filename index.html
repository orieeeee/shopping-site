<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>사이트 계정 관리 (Google Sheet 연동)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Apple SD Gothic Neo, 'Malgun Gothic', Helvetica, Arial, sans-serif; }
    .sticky-col { position: sticky; top: 88px; max-height: calc(100vh - 100px); overflow:auto; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
    .table th { text-align: left; font-weight: 600; color: #475569; background: #f8fafc; }
    .btn { padding: 6px 10px; border-radius: 8px; border: 1px solid #d4d4d8; background: white; font-size: 12px; }
    .btn.red { border-color: #fecaca; background: #fff1f2; color: #b91c1c; }
    .btn.blue { border-color: #bfdbfe; background: #eff6ff; color: #1d4ed8; }
    .btn.gray { background:#f4f4f5; }
    .badge { display:inline-block; padding:2px 8px; font-size:12px; border-radius: 9999px; border:1px solid #e4e4e7; background:#fafafa; }
    .input { width:100%; padding:8px 10px; border:1px solid #e4e4e7; border-radius:8px; background:#f8fafc; }
    .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; }
    .modal { width: 680px; max-width: calc(100vw - 32px); background:white; border:1px solid #e5e7eb; border-radius:16px; }
    .spinner { width:16px; height:16px; border:2px solid #cbd5e1; border-top-color:#334155; border-radius:9999px; animation:spin 1s linear infinite; display:inline-block;}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900 min-h-screen">

  <!-- 헤더 -->
  <header class="sticky top-0 z-20 border-b border-zinc-200 bg-zinc-100/70 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="bg-white border border-zinc-200 rounded-xl p-4">
        <div class="flex items-center gap-3">
          <div class="relative flex-1">
            <input id="q" type="search" placeholder="검색: 사이트 이름/링크/아이디/비밀번호/메모"
                   class="w-full pl-11 pr-12 py-3 rounded-lg border border-zinc-300 focus:outline-none focus:ring-2 focus:ring-zinc-400"
                   autocomplete="off" />
            <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-zinc-400" viewBox="0 0 24 24" fill="none">
              <path d="M21 21l-4.3-4.3M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <button id="clearQ" class="absolute right-2 top-1/2 -translate-y-1/2 px-2 py-1 text-zinc-500 hover:text-zinc-800 text-sm hidden">지우기</button>
          </div>
          <button id="addBtn" class="btn blue text-sm">＋ 사이트 추가</button>
          <span id="loading" class="hidden text-sm text-zinc-500"><span class="spinner"></span> 동기화 중...</span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- 좌측: 카테고리 -->
      <aside class="lg:col-span-3">
        <div class="sticky-col">
          <div class="bg-white border border-zinc-200 rounded-xl">
            <div class="p-4 border-b border-zinc-200 flex items-center justify-between">
              <div class="text-sm font-semibold text-zinc-700">카테고리</div>
              <button id="catEditToggle" class="btn gray text-xs">수정</button>
            </div>
            <div id="catList" class="p-4 space-y-2"><!-- 체크박스 렌더 --></div>
            <div id="catEditArea" class="p-4 border-t border-zinc-100 hidden">
              <div class="flex items-center gap-2">
                <input id="newCat" class="input" placeholder="카테고리 추가" />
                <button id="addCat" class="btn blue">추가</button>
              </div>
              <p class="text-xs text-zinc-500 mt-2">항목 옆 ❌ 로 삭제할 수 있어요.</p>
              <div class="mt-2">
                <button id="resetCats" class="btn text-xs">기본 4개로 초기화</button>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- 우측: 리스트 -->
      <section class="lg:col-span-9">
        <div id="summary" class="text-sm text-zinc-600 mb-3"></div>
        <div class="bg-white border border-zinc-200 rounded-xl overflow-auto">
          <table class="table">
            <thead>
              <tr>
                <th style="width:18%">사이트 이름</th>
                <th style="width:22%">링크</th>
                <th style="width:16%">아이디</th>
                <th style="width:16%">비밀번호</th>
                <th style="width:14%">카테고리</th>
                <th style="width:7%">수정</th>
                <th style="width:7%">삭제</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <p id="empty" class="hidden text-center text-zinc-500 mt-6">조건에 맞는 결과가 없습니다.</p>
      </section>
    </div>
  </main>

  <!-- 추가/수정 모달 -->
  <div id="modalBg" class="modal-bg">
    <div class="modal">
      <div class="p-5 border-b border-zinc-200 flex items-center justify-between">
        <h2 id="modalTitle" class="text-lg font-semibold">사이트 추가</h2>
        <button id="closeModal" class="text-zinc-500 hover:text-zinc-800 text-xl">&times;</button>
      </div>
      <form id="siteForm" class="p-5 grid grid-cols-1 gap-3">
        <input type="hidden" name="id" />
        <div class="grid sm:grid-cols-2 gap-3">
          <label class="grid gap-1">
            <span class="text-sm text-zinc-600">사이트 이름 *</span>
            <input name="name" required class="input" />
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-zinc-600">링크(URL) *</span>
            <input name="url" required placeholder="https://example.com" class="input" />
          </label>
        </div>
        <div class="grid sm:grid-cols-2 gap-3">
          <label class="grid gap-1">
            <span class="text-sm text-zinc-600">아이디</span>
            <input name="username" class="input" />
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-zinc-600">비밀번호</span>
            <input name="password" class="input" />
          </label>
        </div>
        <div class="grid sm:grid-cols-2 gap-3">
          <label class="grid gap-1">
            <span class="text-sm text-zinc-600">카테고리</span>
            <select name="category" class="input" id="categorySelect"></select>
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-zinc-600">메모(선택)</span>
            <input name="note" class="input" />
          </label>
        </div>
        <div class="text-xs text-amber-600">⚠️ 비밀번호는 시트에 **평문 저장**됩니다. 실서비스는 암호화/권한설정 권장.</div>
        <div class="flex items-center justify-end gap-2 mt-2">
          <button type="button" class="btn" id="cancelForm">취소</button>
          <button type="submit" class="btn blue">저장</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ====== API URL (Apps Script Web App URL 붙여넣기) ====== */
    const API_URL = '여기에_웹앱_URL_붙여넣기'; // 예: https://script.google.com/macros/s/AKfycb.../exec
    // 프리플라이트 회피 위해 Content-Type: text/plain 사용 (서버는 e.postData.contents 파싱)

    // ====== State ======
    const $ = (s, el=document)=>el.querySelector(s);
    const $$ = (s, el=document)=>[...el.querySelectorAll(s)];
    const state = { q:'', categories:[], selectedCats:new Set(), rows:[] };

    const loadingOn  = ()=>$('#loading').classList.remove('hidden');
    const loadingOff = ()=>$('#loading').classList.add('hidden');

    // ====== API ======
    async function apiGET(params={}) {
      const url = API_URL + '?' + new URLSearchParams(params).toString();
      const res = await fetch(url, { method:'GET' });
      return res.json();
    }
    async function apiPOST(payload) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });
      return res.json();
    }

    async function loadAll() {
      loadingOn();
      try {
        const data = await apiGET({ action:'list' });
        if (!data.ok) throw new Error('load failed');
        state.rows = data.accounts || [];
        state.categories = (data.categories || []).length ? data.categories : ['쇼핑몰','관리자','개발','업체'];
        // 선택: 기본은 전부 선택
        state.selectedCats = new Set(state.categories);
        renderCategories();
        renderTable();
      } catch (e) {
        alert('데이터 로드 실패: ' + e.message);
      } finally { loadingOff(); }
    }

    // ====== 카테고리 패널 ======
    function renderCategories() {
      const wrap = $('#catList'); wrap.innerHTML='';
      state.categories.forEach(cat=>{
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2';
        row.innerHTML = `
          <label class="flex items-center gap-2 flex-1">
            <input type="checkbox" class="catChk" value="${cat}" ${state.selectedCats.has(cat)?'checked':''}>
            <span>${cat}</span>
          </label>
          <button class="btn red text-xs delCat hidden" data-cat="${cat}">❌</button>
        `;
        wrap.appendChild(row);
      });
      fillCategorySelect();
      const editing = !$('#catEditArea').classList.contains('hidden');
      $$('.delCat').forEach(b=> b.classList.toggle('hidden', !editing));
    }
    function fillCategorySelect(){
      const sel = $('#categorySelect'); sel.innerHTML = '';
      state.categories.forEach(c=>{
        const opt = document.createElement('option');
        opt.value=c; opt.textContent=c; sel.appendChild(opt);
      });
    }

    // ====== 테이블 ======
    function rowMatches(r){
      if (state.selectedCats.size && !state.selectedCats.has(r.category)) return false;
      const q = state.q.trim().toLowerCase();
      if (!q) return true;
      const hay = [r.name,r.url,r.username,r.password,r.note,r.category].join(' ').toLowerCase();
      return hay.includes(q);
    }
    function renderTable(){
      const list = state.rows.filter(rowMatches);
      $('#summary').textContent = `총 ${state.rows.length}개 중 ${list.length}개 표시`;
      const tbody = $('#tbody'); tbody.innerHTML = '';
      list.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name || '-'}</td>
          <td><a class="text-blue-700 hover:underline" href="${r.url || '#'}" target="_blank">${(r.url||'').replace(/^https?:\\/\\//,'')}</a></td>
          <td>${r.username || '-'}</td>
          <td>${r.password || '-'}</td>
          <td><span class="badge">${r.category || '-'}</span></td>
          <td><button class="btn blue editRow" data-id="${r.id}">수정</button></td>
          <td><button class="btn red delRow" data-id="${r.id}">삭제</button></td>
        `;
        tbody.appendChild(tr);
      });
      $('#empty').classList.toggle('hidden', list.length>0);
    }

    // ====== 모달 ======
    const modalBg = $('#modalBg');
    const openModal = (title)=>{ $('#modalTitle').textContent=title; modalBg.style.display='flex'; };
    const closeModal = ()=>{ modalBg.style.display='none'; $('#siteForm').reset(); $('[name=id]').value=''; };

    $('#addBtn').addEventListener('click', ()=>{ fillCategorySelect(); openModal('사이트 추가'); });
    $('#closeModal').addEventListener('click', closeModal);
    $('#cancelForm').addEventListener('click', closeModal);
    modalBg.addEventListener('click', (e)=>{ if (e.target===modalBg) closeModal(); });

    // 수정 클릭
    document.addEventListener('click', (e)=>{
      if (e.target.matches('.editRow')){
        const id = e.target.getAttribute('data-id');
        const row = state.rows.find(x=>String(x.id)===String(id));
        if (!row) return;
        openModal('사이트 수정');
        $('[name=id]').value = row.id;
        $('[name=name]').value = row.name || '';
        $('[name=url]').value = row.url || '';
        $('[name=username]').value = row.username || '';
        $('[name=password]').value = row.password || '';
        fillCategorySelect();
        $('[name=category]').value = row.category || (state.categories[0]||'');
        $('[name=note]').value = row.note || '';
      }
    });

    // 삭제
    document.addEventListener('click', async (e)=>{
      if (e.target.matches('.delRow')){
        const id = e.target.getAttribute('data-id');
        if (!confirm('이 항목을 삭제할까요?')) return;
        loadingOn();
        try{
          const res = await apiPOST({ action:'deleteAccount', id });
          if (!res.ok) throw new Error(res.error || 'delete failed');
          // 로컬 목록 갱신
          state.rows = state.rows.filter(x=>String(x.id)!==String(id));
          renderTable();
        } catch(err){ alert('삭제 실패: ' + err.message); }
        finally{ loadingOff(); }
      }
    });

    // 저장(추가/수정)
    $('#siteForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const id = (fd.get('id')||'').toString();
      const name = (fd.get('name')||'').toString().trim();
      let url = (fd.get('url')||'').toString().trim();
      if (!name || !url) { alert('사이트 이름과 링크는 필수입니다.'); return; }
      if (!/^https?:\\/\\//i.test(url)) url = 'https://' + url;
      const item = {
        id, name, url,
        username: (fd.get('username')||'').toString(),
        password: (fd.get('password')||'').toString(),
        category: (fd.get('category')||'').toString() || (state.categories[0]||''),
        note: (fd.get('note')||'').toString()
      };
      loadingOn();
      try{
        const res = await apiPOST({ action:'upsertAccount', item });
        if (!res.ok) throw new Error(res.error || 'save failed');
        // 성공 후 재조회(정합성)
        await loadAll();
        closeModal();
      } catch(err){ alert('저장 실패: ' + err.message); }
      finally{ loadingOff(); }
    });

    // 카테고리 편집 모드
    $('#catEditToggle').addEventListener('click', ()=>{
      const area = $('#catEditArea');
      const nowHidden = area.classList.toggle('hidden');
      $('#catEditToggle').textContent = nowHidden ? '수정' : '수정 종료';
      $$('.delCat').forEach(b=> b.classList.toggle('hidden', nowHidden));
    });

    // 카테고리 추가/삭제/초기화
    $('#addCat').addEventListener('click', async ()=>{
      const v = ($('#newCat').value||'').trim();
      if (!v) return;
      loadingOn();
      try{
        const res = await apiPOST({ action:'addCategory', name:v });
        if (!res.ok) throw new Error(res.error||'addCategory failed');
        $('#newCat').value='';
        // 최신 목록
        const r = await apiGET({ action:'categories' });
        state.categories = r.categories || [];
        renderCategories(); renderTable();
      } catch(err){ alert('카테고리 추가 실패: ' + err.message); }
      finally{ loadingOff(); }
    });
    document.addEventListener('click', async (e)=>{
      if (e.target.matches('.delCat')) {
        const cat = e.target.getAttribute('data-cat');
        if (!confirm(`[${cat}] 카테고리를 삭제할까요?`)) return;
        loadingOn();
        try{
          const res = await apiPOST({ action:'deleteCategory', name:cat });
          if (!res.ok) throw new Error(res.error||'deleteCategory failed');
          const r = await apiGET({ action:'categories' });
          state.categories = r.categories || [];
          // 선택 집합도 갱신
          state.selectedCats.delete(cat);
          renderCategories(); renderTable();
        } catch(err){ alert('카테고리 삭제 실패: ' + err.message); }
        finally{ loadingOff(); }
      }
    });
    $('#resetCats').addEventListener('click', async ()=>{
      if (!confirm('카테고리를 기본 4개(쇼핑몰/관리자/개발/업체)로 초기화할까요?')) return;
      loadingOn();
      try{
        const res = await apiPOST({ action:'resetCategories' });
        if (!res.ok) throw new Error(res.error||'resetCategories failed');
        state.categories = res.categories || ['쇼핑몰','관리자','개발','업체'];
        state.selectedCats = new Set(state.categories);
        renderCategories(); renderTable();
      } catch(err){ alert('초기화 실패: ' + err.message); }
      finally{ loadingOff(); }
    });

    // 카테고리 필터 변경
    document.addEventListener('change', (e)=>{
      if (e.target.matches('.catChk')) {
        const v = e.target.value;
        if (e.target.checked) state.selectedCats.add(v); else state.selectedCats.delete(v);
        renderTable();
      }
    });

    // 검색
    $('#q').addEventListener('input', e=>{
      state.q = e.target.value;
      $('#clearQ').classList.toggle('hidden', !state.q);
      renderTable();
    });
    $('#clearQ').addEventListener('click', ()=>{
      $('#q').value=''; state.q=''; $('#clearQ').classList.add('hidden'); renderTable();
    });

    // 초기 로드
    loadAll();
  </script>
</body>
</html>
