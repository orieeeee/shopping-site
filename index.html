<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‚¬ì´íŠ¸ ê³„ì • ê´€ë¦¬ (Google Sheet ì—°ë™)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Apple SD Gothic Neo, 'Malgun Gothic', Helvetica, Arial, sans-serif; }
    .sticky-col { position: sticky; top: 88px; max-height: calc(100vh - 100px); overflow:auto; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
    .table th { text-align: left; font-weight: 600; color: #475569; background: #f8fafc; }
    .btn { padding: 6px 10px; border-radius: 8px; border: 1px solid #d4d4d8; background: white; font-size: 12px; }
    .btn.red { border-color: #fecaca; background: #fff1f2; color: #b91c1c; }
    .btn.blue { border-color: #bfdbfe; background: #eff6ff; color: #1d4ed8; }
    .btn.gray { background:#f4f4f5; }
    .badge { display:inline-block; padding:2px 8px; font-size:12px; border-radius: 9999px; border:1px solid #e4e4e7; background:#fafafa; }
    .input { width:100%; padding:8px 10px; border:1px solid #e4e4e7; border-radius:8px; background:#f8fafc; }
    .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; }
    .modal { width: 680px; max-width: calc(100vw - 32px); background:white; border:1px solid #e5e7eb; border-radius:16px; }
    .spinner { width:16px; height:16px; border:2px solid #cbd5e1; border-top-color:#334155; border-radius:9999px; animation:spin 1s linear infinite; display:inline-block;}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900 min-h-screen">

  <!-- í—¤ë” -->
  <header class="sticky top-0 z-20 border-b border-zinc-200 bg-zinc-100/70 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="bg-white border border-zinc-200 rounded-xl p-4">
        <div class="flex items-center gap-3">
          <div class="relative flex-1">
            <input id="q" type="search" placeholder="ê²€ìƒ‰: ì‚¬ì´íŠ¸ ì´ë¦„/ë§í¬/ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸/ë©”ëª¨"
                   class="w-full pl-11 pr-12 py-3 rounded-lg border border-zinc-300 focus:outline-none focus:ring-2 focus:ring-zinc-400"
                   autocomplete="off" />
            <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-zinc-400" viewBox="0 0 24 24" fill="none">
              <path d="M21 21l-4.3-4.3M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <button id="clearQ" class="absolute right-2 top-1/2 -translate-y-1/2 px-2 py-1 text-zinc-500 hover:text-zinc-800 text-sm hidden">ì§€ìš°ê¸°</button>
          </div>
          <button id="addBtn" class="btn blue text-sm">ï¼‹ ì‚¬ì´íŠ¸ ì¶”ê°€</button>
          <span id="loading" class="hidden text-sm text-zinc-500"><span class="spinner"></span> ë™ê¸°í™” ì¤‘...</span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- ì¢Œì¸¡: ì¹´í…Œê³ ë¦¬ -->
      <aside class="lg:col-span-3">
        <div class="sticky-col">
          <div class="bg-white border border-zinc-200 rounded-xl">
            <div class="p-4 border-b border-zinc-200 flex items-center justify-between">
              <div class="text-sm font-semibold text-zinc-700">ì¹´í…Œê³ ë¦¬</div>
              <button id="catEditToggle" class="btn gray text-xs">ìˆ˜ì •</button>
            </div>
            <div id="catList" class="p-4 space-y-2"><!-- ì²´í¬ë°•ìŠ¤ ë Œë” --></div>
            <div id="catEditArea" class="p-4 border-t border-zinc-100 hidden">
              <div class="flex items-center gap-2">
                <input id="newCat" class="input" placeholder="ì¹´í…Œê³ ë¦¬ ì¶”ê°€" />
                <button id="addCat" class="btn blue">ì¶”ê°€</button>
              </div>
              <p class="text-xs text-zinc-500 mt-2">í•­ëª© ì˜† âŒ ë¡œ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”.</p>
              <div class="mt-2">
                <button id="resetCats" class="btn text-xs">ê¸°ë³¸ 4ê°œë¡œ ì´ˆê¸°í™”</button>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- ìš°ì¸¡: ë¦¬ìŠ¤íŠ¸ -->
      <section class="lg:col-span-9">
        <div id="summary" class="text-sm text-zinc-600 mb-3"></div>
        <div class="bg-white border border-zinc-200 rounded-xl overflow-auto">
          <table class="table">
            <thead>
              <tr>
                <th style="width:18%">ì‚¬ì´íŠ¸ ì´ë¦„</th>
                <th style="width:22%">ë§í¬</th>
                <th style="width:16%">ì•„ì´ë””</th>
                <th style="width:16%">ë¹„ë°€ë²ˆí˜¸</th>
                <th style="width:14%">ì¹´í…Œê³ ë¦¬</th>
                <th style="width:7%">ìˆ˜ì •</th>
                <th style="width:7%">ì‚­ì œ</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <p id="empty" class="hidden text-center text-zinc-500 mt-6">ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </section>
    </div>
  </main>

  <!-- ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="modalBg" class="modal-bg">
    <div class="modal">
      <div class="p-5 border-b border-zinc-200 flex items-center justify-between">
        <h2 id="modalTitle" class="text-lg font-semibold">ì‚¬ì´íŠ¸ ì¶”ê°€</h2>
        <button id="closeModal" class="text-zinc-500 hover:text-zinc-800 text-xl">&times;</button>
      </div>
      <form id="siteForm" class="p-5 grid grid-cols-1 gap-3">
        <input type="hidden" name="id" />
        <div class="grid sm:grid-cols-2 gap-3">
          <label class="grid gap-1">
            <span class="text-sm text-zinc-600">ì‚¬ì´íŠ¸ ì´ë¦„ *</span>
            <input name="name" required class="input" />
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-zinc-600">ë§í¬(URL) *</span>
            <input name="url" required placeholder="https://example.com" class="input" />
          </label>
        </div>
        <div class="grid sm:grid-cols-2 gap-3">
          <label class="grid gap-1">
            <span class="text-sm text-zinc-600">ì•„ì´ë””</span>
            <input name="username" class="input" />
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-zinc-600">ë¹„ë°€ë²ˆí˜¸</span>
            <input name="password" class="input" />
          </label>
        </div>
        <div class="grid sm:grid-cols-2 gap-3">
          <label class="grid gap-1">
            <span class="text-sm text-zinc-600">ì¹´í…Œê³ ë¦¬</span>
            <select name="category" class="input" id="categorySelect"></select>
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-zinc-600">ë©”ëª¨(ì„ íƒ)</span>
            <input name="note" class="input" />
          </label>
        </div>
        <div class="text-xs text-amber-600">âš ï¸ ë¹„ë°€ë²ˆí˜¸ëŠ” ì‹œíŠ¸ì— **í‰ë¬¸ ì €ì¥**ë©ë‹ˆë‹¤. ì‹¤ì„œë¹„ìŠ¤ëŠ” ì•”í˜¸í™”/ê¶Œí•œì„¤ì • ê¶Œì¥.</div>
        <div class="flex items-center justify-end gap-2 mt-2">
          <button type="button" class="btn" id="cancelForm">ì·¨ì†Œ</button>
          <button type="submit" class="btn blue">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  /* ====== API URL (Apps Script Web App URL ë¶™ì—¬ë„£ê¸°) ====== */
  // ì˜ˆ: const API_URL = 'https://script.google.com/macros/s/AKfycb.../exec';
  /* ====== API URL (Apps Script Web App URL ë¶™ì—¬ë„£ê¸°) ====== */
const API_URL = 'https://script.google.com/a/macros/magicbeangame.com/s/AKfycbyKOr1I1cbiKHH5yXx5t2vQ8fIM8KlNGRDM2IkGT38F4g-mmNfNgJu_H0j6xwgpQu3C/exec';


  // ====== State ======
  const $ = (s, el=document)=>el.querySelector(s);
  const $$ = (s, el=document)=>[...el.querySelectorAll(s)];
  const state = { q:'', categories:[], selectedCats:new Set(), rows:[] };

  const loadingOn  = ()=>{ const el = $('#loading'); if (el) el.classList.remove('hidden'); };
  const loadingOff = ()=>{ const el = $('#loading'); if (el) el.classList.add('hidden'); };

  // ====== API ======
  const hasValidApi = /^https?:\/\/.+\/exec(\?|$)/.test(API_URL);

  async function apiGET(params={}) {
    if (!hasValidApi) throw new Error('API_URL ë¯¸ì„¤ì •');
    const url = API_URL + '?' + new URLSearchParams(params).toString();
    const res = await fetch(url, { method:'GET' });
    if (!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }
  async function apiPOST(payload) {
    if (!hasValidApi) throw new Error('API_URL ë¯¸ì„¤ì •');
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' }, // Apps Scriptì—ì„œ e.postData.contentsë¡œ íŒŒì‹±
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }

  async function loadAll() {
    loadingOn();
    try {
      if (!hasValidApi) {
        // ğŸ”§ API_URLì´ ì•„ì§ ë¹„ì–´ìˆì–´ë„ UIëŠ” ë¨¼ì € ì‚´ì•„ìˆê²Œ ê¸°ë³¸ ì¹´í…Œê³ ë¦¬/ë¹ˆ ëª©ë¡ ì„¸íŒ…
        state.rows = [];
        state.categories = ['ì‡¼í•‘ëª°','ê´€ë¦¬ì','ê°œë°œ','ì—…ì²´'];
        state.selectedCats = new Set(state.categories);
        renderCategories();
        renderTable();
        console.warn('API_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì‹œíŠ¸ ì—°ê²°ì„ ê±´ë„ˆëœ€. API_URL ì±„ìš°ë©´ ì‹¤ë°ì´í„°ë¡œ ë™ì‘í•©ë‹ˆë‹¤.');
        return;
      }
      const data = await apiGET({ action:'list' });
      if (!data.ok) throw new Error(data.error || 'load failed');
      state.rows = data.accounts || [];
      state.categories = (data.categories || []).length ? data.categories : ['ì‡¼í•‘ëª°','ê´€ë¦¬ì','ê°œë°œ','ì—…ì²´'];
      state.selectedCats = new Set(state.categories);
      renderCategories();
      renderTable();
    } catch (e) {
      alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
      // ì‹¤íŒ¨í•´ë„ UIëŠ” ë¹ˆ ìƒíƒœë¡œ ì‘ë™
      if (!state.categories.length) {
        state.categories = ['ì‡¼í•‘ëª°','ê´€ë¦¬ì','ê°œë°œ','ì—…ì²´'];
        state.selectedCats = new Set(state.categories);
        renderCategories();
        renderTable();
      }
    } finally { loadingOff(); }
  }
  /* ë‚˜ë¨¸ì§€ ê¸°ì¡´ ì½”ë“œ(ì¹´í…Œê³ ë¦¬/í…Œì´ë¸”/ëª¨ë‹¬/ì´ë²¤íŠ¸/ì´ˆê¸° loadAll í˜¸ì¶œ)ëŠ” ê·¸ëŒ€ë¡œ ë‘ì„¸ìš” */
</script>

</body>
</html>
