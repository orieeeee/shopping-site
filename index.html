<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>사이트 계정 관리 (Google Sheet 연동)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Apple SD Gothic Neo, 'Malgun Gothic', Helvetica, Arial, sans-serif; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
    .table th { text-align: left; font-weight: 600; color: #475569; background: #f8fafc; }
    .btn { padding: 6px 10px; border-radius: 8px; border: 1px solid #d4d4d8; background: white; font-size: 12px; }
    .btn.red { border-color: #fecaca; background: #fff1f2; color: #b91c1c; }
    .btn.blue { border-color: #bfdbfe; background: #eff6ff; color: #1d4ed8; }
    .btn.gray { background:#f4f4f5; }
    .badge { display:inline-block; padding:2px 8px; font-size:12px; border-radius: 9999px; border:1px solid #e4e4e7; background:#fafafa; }
    .input { width:100%; padding:8px 10px; border:1px solid #e4e4e7; border-radius:8px; background:#f8fafc; }
    .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; }
    .modal { width: 680px; max-width: calc(100vw - 32px); background:white; border:1px solid #e5e7eb; border-radius:16px; }
    .spinner { width:16px; height:16px; border:2px solid #cbd5e1; border-top-color:#334155; border-radius:9999px; animation:spin 1s linear infinite; display:inline-block;}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* 메모 팝업 */
    #notePopup{ position: fixed; z-index: 50; display:none; max-width: 300px; padding:10px 12px; border-radius:12px;
      background:white; border:1px solid #e5e7eb; box-shadow:0 10px 20px rgba(0,0,0,.08); font-size: 13px; color:#374151; line-height:1.4;}
    #notePopup .closeX{ position:absolute; right:8px; top:6px; font-size:16px; color:#6b7280; }
    .noteIconBtn{ display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border:1px solid #e4e4e7; border-radius:8px; background:#fff; }
    .noteIconBtn:hover{ background:#f8fafc; }
    .noteIconBtn svg{ width:18px; height:18px; color:#0f172a; }

    /* 카테고리 바 (칩) */
    #catBar { display:flex; align-items:center; gap:10px; overflow-x:auto; white-space:nowrap; padding:10px 14px; }
    .chip {
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 14px; border:1px solid #d4d4d8; border-radius:9999px;
      background:#ffffff; color:#374151; font-size:13px; cursor:pointer;
      transition: background .15s, color .15s, border-color .15s, box-shadow .15s;
    }
    .chip.active { background:#3f3f46; color:#ffffff; border-color:#3f3f46; box-shadow: inset 0 0 0 1px rgba(255,255,255,.15);}
    .chip:hover { box-shadow:0 1px 0 rgba(0,0,0,.04); }
    .chip .x { display:none; margin-left:4px; font-weight:700; }
    #catBar.delete-mode .chip .x { display:inline; }
    .chip.plus { background:#ffffff; color:#1d4ed8; border-color:#bfdbfe; }
    .chip.plus:hover { background:#eff6ff; }
	
	.icon-btn {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	width: 34px;
	height: 34px;
	border-radius: 8px;
	border: 1px solid #bfdbfe;
	background: #eff6ff;
	color: #1d4ed8;
	transition: background .15s, transform .1s;
	}
	.icon-btn:hover { background: #dbeafe; transform: scale(1.05); }

	.icon-btn.red {
	border-color: #fecaca;
	background: #fff1f2;
	color: #b91c1c;
	}
	.icon-btn.red:hover { background: #fee2e2; transform: scale(1.05); }
 
 </style>
</head>
<body class="bg-zinc-50 text-zinc-900 min-h-screen">

  <!-- 헤더 -->
  <header class="sticky top-0 z-20 border-b border-zinc-200 bg-zinc-100/70 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="bg-white border border-zinc-200 rounded-xl p-4">
        <div class="flex items-center gap-3">
          <div class="relative flex-1">
            <input id="q" type="search" placeholder="검색: 사이트 이름/링크/아이디/비밀번호/메모"
              class="w-full pl-11 pr-12 py-3 rounded-lg border border-zinc-300 focus:outline-none focus:ring-2 focus:ring-zinc-400"
              autocomplete="off" />
            <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-zinc-400" viewBox="0 0 24 24" fill="none">
              <path d="M21 21l-4.3-4.3M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <button id="clearQ" class="absolute right-2 top-1/2 -translate-y-1/2 px-2 py-1 text-zinc-500 hover:text-zinc-800 text-sm hidden">지우기</button>
          </div>
          <button id="addBtn" class="btn blue text-sm">＋ 사이트 추가</button>
          <span id="loading" class="hidden text-sm text-zinc-500"><span class="spinner"></span> 동기화 중...</span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- 카테고리 바 -->
    <section id="catBarWrap" class="bg-white border border-zinc-200 rounded-xl">
      <div class="px-4 py-3 border-b border-zinc-200 flex items-center justify-between">
        <div class="text-sm font-semibold text-zinc-700">카테고리</div>
        <button id="catDeleteToggle" class="btn text-xs">삭제</button>
      </div>
      <div id="catBar"><!-- 칩 렌더링 --></div>
    </section>

    <!-- 리스트(테이블) -->
    <section>
      <div id="summary" class="text-sm text-zinc-600 mb-3"></div>
      <div class="bg-white border border-zinc-200 rounded-xl overflow-auto">
        <table class="table">
          <thead>
            <tr>
              <th style="width:18%">사이트 이름</th>
              <th style="width:22%">링크</th>
              <th style="width:14%">ID</th>
              <th style="width:14%">PW</th>
              <th style="width:12%">분류</th>
              <th style="width:8%">메모</th>
              <th style="width:6%">수정</th>
              <th style="width:6%">삭제</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <p id="empty" class="hidden text-center text-zinc-500 mt-6">조건에 맞는 결과가 없습니다.</p>
    </section>
  </main>

  <!-- 메모 팝업 -->
  <div id="notePopup">
    <button class="closeX" aria-label="닫기">&times;</button>
    <div id="notePopupBody" class="pr-5 whitespace-pre-wrap"></div>
  </div>

  <!-- 추가/수정 모달 -->
  <div id="modalBg" class="modal-bg">
    <div class="modal">
      <div class="p-5 border-b border-zinc-200 flex items-center justify-between">
        <h2 id="modalTitle" class="text-lg font-semibold">사이트 추가</h2>
        <button id="closeModal" class="text-zinc-500 hover:text-zinc-800 text-xl">&times;</button>
      </div>
      <form id="siteForm" class="p-5 grid grid-cols-1 gap-3">
        <input type="hidden" name="id" />
        <div class="grid sm:grid-cols-2 gap-3">
          <label class="grid gap-1"><span class="text-sm text-zinc-600">사이트 이름 *</span><input name="name" required class="input" /></label>
          <label class="grid gap-1"><span class="text-sm text-zinc-600">링크(URL) *</span><input name="url" required placeholder="https://example.com" class="input" /></label>
        </div>
        <div class="grid sm:grid-cols-2 gap-3">
          <label class="grid gap-1"><span class="text-sm text-zinc-600">아이디</span><input name="username" class="input" /></label>
          <label class="grid gap-1"><span class="text-sm text-zinc-600">비밀번호</span><input name="password" class="input" /></label>
        </div>
        <div class="grid sm:grid-cols-2 gap-3">
          <label class="grid gap-1"><span class="text-sm text-zinc-600">카테고리</span><select name="category" class="input" id="categorySelect"></select></label>
          <label class="grid gap-1"><span class="text-sm text-zinc-600">메모(선택)</span><input name="note" class="input" /></label>
        </div>
        <div class="text-xs text-amber-600">⚠️ 비밀번호는 시트에 **평문 저장**됩니다. 실서비스는 암호화/권한설정 권장.</div>
        <div class="flex items-center justify-end gap-2 mt-2">
          <button type="button" class="btn" id="cancelForm">취소</button>
          <button type="submit" class="btn blue">저장</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  /* ====== API URL ====== */
  const API_URL = 'https://script.google.com/macros/s/AKfycbwhqNLE6_MUja-FtHlh4IXI-nRmTeBCnQx3hLz4wI6KZrxIrGHsC-FHbZfFETlXCbji/exec';

  /* ====== Helpers & State ====== */
  const $ = (s, el=document)=>el.querySelector(s);
  const $$ = (s, el=document)=>[...el.querySelectorAll(s)];
  const state = { q:'', categories:[], selectedCats:new Set(), rows:[], deleteMode:false };
  const loadingOn  = ()=>{ const el = $('#loading'); if (el) el.classList.remove('hidden'); };
  const loadingOff = ()=>{ const el = $('#loading'); if (el) el.classList.add('hidden'); };
  const hasValidApi = /^https?:\/\/.+\/exec(\?|$)/.test(API_URL);

  async function apiGET(params={}) {
    if (!hasValidApi) throw new Error('API_URL 미설정');
    const url = API_URL + '?' + new URLSearchParams(params).toString();
    const res = await fetch(url, { method:'GET' });
    if (!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }
  async function apiPOST(payload) {
    if (!hasValidApi) throw new Error('API_URL 미설정');
    const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
    if (!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }

  /* ====== 카테고리 바 렌더 ====== */
  function renderCategoryBar(){
    const bar = $('#catBar'); bar.innerHTML='';
    // 칩들
    state.categories.forEach(cat=>{
      const btn = document.createElement('button');
      btn.className = 'chip' + (state.selectedCats.has(cat) ? ' active' : '');
      btn.setAttribute('data-cat', cat);
      btn.innerHTML = `<span>${cat}</span><span class="x" title="삭제">×</span>`;
      bar.appendChild(btn);
    });
    // + 칩
    const add = document.createElement('button');
    add.id='catAddBtn';
    add.className='chip plus';
    add.innerHTML = '＋';
    bar.appendChild(add);

    // 삭제 모드 표시
    bar.classList.toggle('delete-mode', state.deleteMode);
    $('#catDeleteToggle').textContent = state.deleteMode ? '삭제 종료' : '삭제';
    fillCategorySelect();
  }

  function fillCategorySelect(){
    const sel = $('#categorySelect'); sel.innerHTML='';
    state.categories.forEach(c=>{
      const opt = document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt);
    });
  }

  /* ====== 필터/검색 ====== */
  function rowMatches(r){
    if (state.selectedCats.size && !state.selectedCats.has(r.category)) return false;
    const q = state.q.trim().toLowerCase(); if (!q) return true;
    const hay = [r.name,r.url,r.username,r.password,r.note,r.category].join(' ').toLowerCase();
    return hay.includes(q);
  }

  /* ====== 메모 아이콘 ====== */
  function noteIconSVG(){
    return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="3.5" y="3.5" width="13" height="17" rx="2"></rect>
      <path d="M7.5 8h6M7.5 12h6M7.5 16h4"></path>
      <path d="M14.5 6.5l3.2-3.2a1.2 1.2 0 0 1 1.7 0l1.3 1.3a1.2 1.2 0 0 1 0 1.7L17.5 9.5l-3-3z"></path>
      <path d="M14 7l3 3"></path>
    </svg>`;
  }

  function renderTable(){
  const list = state.rows.filter(rowMatches);
  $('#summary').textContent = `총 ${state.rows.length}개 중 ${list.length}개 표시`;
  const tbody = $('#tbody'); tbody.innerHTML = '';

  list.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.name || '-'}</td>
      <td><a class="text-blue-700 hover:underline" href="${r.url || '#'}" target="_blank">${(r.url||'').replace(/^https?:\/\/\/?/,'')}</a></td>
      <td>${r.username || '-'}</td>
      <td>${r.password || '-'}</td>
      <td><span class="badge">${r.category || '-'}</span></td>
      <td>
        ${r.note
          ? `<button class="noteIconBtn noteBtn" title="메모 보기" data-note="${(r.note||'').replace(/"/g,'&quot;')}">
               ${noteIconSVG()}
             </button>`
          : `<span class="text-zinc-400">-</span>`}
      </td>
      <td>
        <button class="icon-btn editRow" title="수정" data-id="${r.id}">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
               stroke-width="2" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M16.862 4.487a2.1 2.1 0 0 1 2.971 2.971l-9.95 9.95a1 1 0 0 1-.45.26l-3.26.814a.5.5 0 0 1-.606-.606l.814-3.26a1 1 0 0 1 .26-.45l9.95-9.95z"/>
          </svg>
        </button>
      </td>
      <td>
        <button class="icon-btn red delRow" title="삭제" data-id="${r.id}">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
               class="w-5 h-5">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  $('#empty').classList.toggle('hidden', list.length>0);
}

  /* ====== 초기 로드 ====== */
  async function loadAll() {
    loadingOn();
    try {
      if (!hasValidApi) {
        state.rows = [];
        state.categories = ['쇼핑몰','관리자','개발','업체'];
        state.selectedCats = new Set(state.categories);
        renderCategoryBar(); renderTable();
        console.warn('API_URL 미설정: UI만 표시됩니다.');
        return;
      }
      const data = await apiGET({ action:'list' });
      if (!data.ok) throw new Error(data.error || 'load failed');
      state.rows = data.accounts || [];
      state.categories = (data.categories || []).length ? data.categories : ['쇼핑몰','관리자','개발','업체'];
      state.selectedCats = new Set(state.categories);
      renderCategoryBar(); renderTable();
    } catch (e) {
      alert('데이터 로드 실패: ' + e.message);
      if (!state.categories.length) {
        state.categories = ['쇼핑몰','관리자','개발','업체'];
        state.selectedCats = new Set(state.categories);
        renderCategoryBar(); renderTable();
      }
    } finally { loadingOff(); }
  }

  /* ====== 상단 검색/추가 ====== */
  const modalBg = $('#modalBg');
  const openModal = (title)=>{ $('#modalTitle').textContent=title; modalBg.style.display='flex'; };
  const closeModal = ()=>{ modalBg.style.display='none'; $('#siteForm').reset(); $('[name=id]').value=''; };

  $('#addBtn').addEventListener('click', ()=>{ fillCategorySelect(); openModal('사이트 추가'); });
  $('#q').addEventListener('input', e=>{
    state.q = e.target.value;
    $('#clearQ').classList.toggle('hidden', !state.q);
    renderTable();
  });
  $('#clearQ').addEventListener('click', ()=>{ $('#q').value=''; state.q=''; $('#clearQ').classList.add('hidden'); renderTable(); });

  /* ====== 모달 ====== */
  $('#closeModal').addEventListener('click', closeModal);
  $('#cancelForm').addEventListener('click', closeModal);
  modalBg.addEventListener('click', (e)=>{ if (e.target===modalBg) closeModal(); });

  /* ====== 행 수정/삭제 ====== */
  document.addEventListener('click', (e)=>{
    if (e.target.matches('.editRow')){
      const id = e.target.getAttribute('data-id');
      const row = state.rows.find(x=>String(x.id)===String(id));
      if (!row) return;
      openModal('사이트 수정');
      $('[name=id]').value = row.id;
      $('[name=name]').value = row.name || '';
      $('[name=url]').value = row.url || '';
      $('[name=username]').value = row.username || '';
      $('[name=password]').value = row.password || '';
      fillCategorySelect();
      $('[name=category]').value = row.category || (state.categories[0]||'');
      $('[name=note]').value = row.note || '';
    }
  });
  document.addEventListener('click', async (e)=>{
    if (e.target.matches('.delRow')){
      const id = e.target.getAttribute('data-id');
      if (!confirm('이 항목을 삭제할까요?')) return;
      loadingOn();
      try{
        const res = await apiPOST({ action:'deleteAccount', id });
        if (!res.ok) throw new Error(res.error || 'delete failed');
        state.rows = state.rows.filter(x=>String(x.id)!==String(id));
        renderTable();
      } catch(err){ alert('삭제 실패: ' + err.message); }
      finally{ loadingOff(); }
    }
  });

  /* ====== 폼 저장 ====== */
  $('#siteForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const id = (fd.get('id')||'').toString();
    const name = (fd.get('name')||'').toString().trim();
    let url = (fd.get('url')||'').toString().trim();
    if (!name || !url) { alert('사이트 이름과 링크는 필수입니다.'); return; }
    if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
    const item = { id, name, url,
      username: (fd.get('username')||'').toString(),
      password: (fd.get('password')||'').toString(),
      category: (fd.get('category')||'').toString() || (state.categories[0]||''),
      note: (fd.get('note')||'').toString()
    };
    loadingOn();
    try{
      const res = await apiPOST({ action:'upsertAccount', item });
      if (!res.ok) throw new Error(res.error || 'save failed');
      await loadAll();
      closeModal();
    } catch(err){ alert('저장 실패: ' + err.message); }
    finally{ loadingOff(); }
  });

  /* ====== 카테고리 바 상호작용 ====== */
  // 칩 클릭(선택 토글) & x 삭제
  document.addEventListener('click', async (e)=>{
    const chip = e.target.closest('.chip');
    if (chip && !chip.classList.contains('plus')) {
      const cat = chip.getAttribute('data-cat');
      // 삭제 모드에서 X 클릭
      if (e.target.classList.contains('x') && state.deleteMode){
        if (!confirm(`[${cat}] 카테고리를 삭제할까요?`)) return;
        loadingOn();
        try{
          const res = await apiPOST({ action:'deleteCategory', name:cat });
          if (!res.ok) throw new Error(res.error||'deleteCategory failed');
          const r = await apiGET({ action:'categories' });
          state.categories = r.categories || [];
          state.selectedCats.delete(cat);
          renderCategoryBar(); renderTable();
        } catch(err){ alert('카테고리 삭제 실패: ' + err.message); }
        finally{ loadingOff(); }
        return;
      }
      // 일반 클릭: 선택 토글
      if (state.selectedCats.has(cat)) state.selectedCats.delete(cat);
      else state.selectedCats.add(cat);
      chip.classList.toggle('active');
      renderTable();
    }
  });

  // + 칩으로 카테고리 추가
  document.addEventListener('click', async (e)=>{
    if (e.target.id === 'catAddBtn' || e.target.closest('#catAddBtn')){
      const v = (prompt('추가할 카테고리 이름을 입력하세요')||'').trim();
      if (!v) return;
      loadingOn();
      try{
        const res = await apiPOST({ action:'addCategory', name:v });
        if (!res.ok) throw new Error(res.error||'addCategory failed');
        const r = await apiGET({ action:'categories' });
        state.categories = r.categories || [];
        state.selectedCats.add(v);
        renderCategoryBar(); renderTable();
      } catch(err){ alert('카테고리 추가 실패: ' + err.message); }
      finally{ loadingOff(); }
    }
  });

  // 삭제 모드 토글
  $('#catDeleteToggle').addEventListener('click', ()=>{
    state.deleteMode = !state.deleteMode;
    renderCategoryBar();
  });

  /* ====== 메모 팝업 ====== */
  const notePopup = $('#notePopup'), noteBody  = $('#notePopupBody');
  $('#notePopup .closeX').addEventListener('click', ()=> notePopup.style.display='none');
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.noteBtn');
    if (btn){
      const note = btn.getAttribute('data-note') || '';
      noteBody.textContent = note;
      const rect = btn.getBoundingClientRect();
      notePopup.style.top = `${rect.bottom + 8}px`;
      notePopup.style.left = `${Math.min(rect.left, window.innerWidth - 320)}px`;
      notePopup.style.display = 'block';
      return;
    }
    if (!notePopup.contains(e.target)) notePopup.style.display = 'none';
  });

  /* ====== 마지막 호출 ====== */
  async function boot(){ await loadAll(); }
  boot();
  </script>

</body>
</html>
